<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–µ–Ω—á–º–∞—Ä–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π –≤ –ú–∞—Ñ–∏–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .controls h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
        }

        .control-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .control-item input, .control-item select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .control-item input:focus, .control-item select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #495057;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results-header {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #28a745;
        }

        .results-header h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 4px solid #667eea;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-container h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .heatmap-container {
            grid-column: 1 / -1;
            margin-bottom: 30px;
        }

        .heatmap {
            display: grid;
            grid-template-columns: auto repeat(10, 1fr);
            gap: 2px;
            margin: 20px 0;
        }

        .heatmap-cell {
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border-radius: 3px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .heatmap-header {
            background: #2c3e50;
            color: white;
        }

        .heatmap-role {
            background: #34495e;
            color: white;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .statistical-tests {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .statistical-tests h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .test-result {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }

        .export-section {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .export-section h4 {
            color: #0c5460;
            margin-bottom: 15px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .interpretation {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .interpretation h4 {
            color: #155724;
            margin-bottom: 15px;
        }

        .interpretation ul {
            margin-left: 20px;
        }

        .interpretation li {
            margin-bottom: 8px;
            color: #155724;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            .control-group {
                grid-template-columns: 1fr;
            }

            .heatmap {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üé≠ –ë–µ–Ω—á–º–∞—Ä–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π –≤ –ú–∞—Ñ–∏–∏</h1>
        <p>–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π –ø–æ –ø–æ–∑–∏—Ü–∏—è–º –∏–≥—Ä–æ–∫–æ–≤</p>
    </div>

    <div class="content">
        <div class="controls">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>

            <div class="control-group">
                <div class="control-item">
                    <label for="iterations">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π:</label>
                    <select id="iterations">
                        <option value="10000">10,000 (–±—ã—Å—Ç—Ä–æ)</option>
                        <option value="100000">100,000 (—Å—Ä–µ–¥–Ω–µ)</option>
                        <option value="1000000" selected>1,000,000 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                        <option value="5000000">5,000,000 (–º–µ–¥–ª–µ–Ω–Ω–æ)</option>
                        <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    </select>
                </div>

                <div class="control-item" id="custom-iterations" style="display: none;">
                    <label for="custom-value">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                    <input type="number" id="custom-value" min="1000" max="10000000" value="1000000">
                </div>

                <div class="control-item">
                    <label for="batch-size">–†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞:</label>
                    <select id="batch-size">
                        <option value="1">1</option>
                        <option value="10">10</option>
                        <option value="1000">1,000</option>
                        <option value="5000" selected>5,000</option>
                        <option value="10000">10,000</option>
                        <option value="50000">50,000</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="confidence-level">–£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è:</label>
                    <select id="confidence-level">
                        <option value="0.90">90%</option>
                        <option value="0.95" selected>95%</option>
                        <option value="0.99">99%</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="simulation-mode">–†–µ–∂–∏–º —Å–∏–º—É–ª—è—Ü–∏–∏:</label>
                    <select id="simulation-mode">
                        <option value="continuous">–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–±—ã—Å—Ç—Ä—ã–π)</option>
                        <option value="realistic" selected>–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π (–∫–∞–∫ –≤ –∏–≥—Ä–µ)</option>
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="start-benchmark">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫</button>
                <button class="btn btn-danger" id="stop-benchmark" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-secondary" id="reset-results">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            </div>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...</div>
        </div>

        <div class="results" id="results">
            <div class="results-header">
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
                <p id="results-summary">–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ</p>
            </div>

            <div class="summary-stats" id="summary-stats">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <div class="statistical-tests" id="statistical-tests">
                <h4>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã</h4>
                <div class="test-results" id="test-results">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div class="heatmap-container chart-container">
                <h4>üî• –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π –ø–æ –ø–æ–∑–∏—Ü–∏—è–º</h4>
                <div class="heatmap" id="heatmap">
                    <!-- –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-container">
                    <h4>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º</h4>
                    <canvas id="roles-chart"></canvas>
                </div>

                <div class="chart-container">
                    <h4>üìà –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –æ–∂–∏–¥–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</h4>
                    <canvas id="deviations-chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h4>üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h4>
                <table class="data-table" id="results-table">
                    <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </table>
            </div>

            <div class="interpretation" id="interpretation">
                <h4>üîç –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h4>
                <div id="interpretation-content">
                    <!-- –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div class="export-section">
                <h4>üíæ –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h4>
                <button class="btn btn-secondary" id="export-csv">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
                <button class="btn btn-secondary" id="export-json">üìã –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
                <button class="btn btn-secondary" id="export-html">üåê –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ –≤ HTML</button>
            </div>
        </div>
    </div>
</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let benchmarkRunning = false;
    let shouldStop = false;
    let currentResults = null;

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–æ–ª–µ–π (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞)
    const ROLES_CONFIG = {
        red: {
            name: '–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å',
            count: 6,
            color: '#28a745'
        },
        sher: {
            name: '–®–µ—Ä–∏—Ñ',
            count: 1,
            color: '#007bff'
        },
        black: {
            name: '–ú–∞—Ñ–∏—è',
            count: 2,
            color: '#dc3545'
        },
        don: {
            name: '–î–æ–Ω –º–∞—Ñ–∏–∏',
            count: 1,
            color: '#6f42c1'
        }
    };

    const TOTAL_PLAYERS = 10;
    const ROLE_NAMES = Object.keys(ROLES_CONFIG);

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const elements = {
        iterations: document.getElementById('iterations'),
        customIterations: document.getElementById('custom-iterations'),
        customValue: document.getElementById('custom-value'),
        batchSize: document.getElementById('batch-size'),
        confidenceLevel: document.getElementById('confidence-level'),
        simulationMode: document.getElementById('simulation-mode'),
        startBtn: document.getElementById('start-benchmark'),
        stopBtn: document.getElementById('stop-benchmark'),
        resetBtn: document.getElementById('reset-results'),
        progressContainer: document.getElementById('progress-container'),
        progressFill: document.getElementById('progress-fill'),
        progressText: document.getElementById('progress-text'),
        results: document.getElementById('results'),
        summaryStats: document.getElementById('summary-stats'),
        statisticalTests: document.getElementById('statistical-tests'),
        testResults: document.getElementById('test-results'),
        heatmap: document.getElementById('heatmap'),
        resultsTable: document.getElementById('results-table'),
        interpretation: document.getElementById('interpretation-content'),
        exportCsv: document.getElementById('export-csv'),
        exportJson: document.getElementById('export-json'),
        exportHtml: document.getElementById('export-html')
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function () {
        setupEventListeners();
        updateCustomIterationsVisibility();
    });

    function setupEventListeners() {
        elements.iterations.addEventListener('change', updateCustomIterationsVisibility);
        elements.startBtn.addEventListener('click', startBenchmark);
        elements.stopBtn.addEventListener('click', stopBenchmark);
        elements.resetBtn.addEventListener('click', resetResults);
        elements.exportCsv.addEventListener('click', exportToCsv);
        elements.exportJson.addEventListener('click', exportToJson);
        elements.exportHtml.addEventListener('click', exportToHtml);
    }

    function updateCustomIterationsVisibility() {
        const isCustom = elements.iterations.value === 'custom';
        elements.customIterations.style.display = isCustom ? 'block' : 'none';
    }

    // –ê–ª–≥–æ—Ä–∏—Ç–º Fisher-Yates —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    function shuffleRoles(useRealisticMode = false) {
        const roles = [
            'red', 'red', 'red', 'red', 'red', 'red',
            'sher',
            'black', 'black',
            'don'
        ];

        // –í —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∏–º–∏—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –±—Ä–∞—É–∑–µ—Ä–∞
        if (useRealisticMode) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π "—Å–∏–¥" –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞
            // –≠—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ Math.random() –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const seed = Date.now() + Math.random() * 1000000;

            // –ü—Ä–æ—Å—Ç–æ–π PRNG –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–¥–∞ –¥–ª—è —ç—Ç–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
            let randomState = seed % 2147483647;

            function seededRandom() {
                randomState = (randomState * 16807) % 2147483647;
                return (randomState - 1) / 2147483646;
            }

            for (let attempt = 0; attempt < 100; attempt++) {

                // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ Fisher-Yates —Å —Å–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–º
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(seededRandom() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }
            }

        } else {
            // –û–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ Fisher-Yates (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º)
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }
        }

        return roles;
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–µ–Ω—á–º–∞—Ä–∫–∞
    async function startBenchmark() {
        if (benchmarkRunning) return;

        benchmarkRunning = true;
        shouldStop = false;

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const iterations = getIterationsCount();
        const batchSize = parseInt(elements.batchSize.value);
        const confidenceLevel = parseFloat(elements.confidenceLevel.value);
        const simulationMode = elements.simulationMode.value;
        const useRealisticMode = simulationMode === 'realistic';

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        elements.startBtn.disabled = true;
        elements.stopBtn.disabled = false;
        elements.progressContainer.style.display = 'block';
        elements.results.style.display = 'none';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ç—Ä–∏—Ü—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const distributionMatrix = {};
        ROLE_NAMES.forEach(role => {
            distributionMatrix[role] = new Array(TOTAL_PLAYERS).fill(0);
        });

        let completedIterations = 0;
        const startTime = Date.now();

        try {
            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞—Ç—á–∞–º–∏
            while (completedIterations < iterations && !shouldStop) {
                const currentBatchSize = Math.min(batchSize, iterations - completedIterations);

                // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞—Ç—á–∞
                for (let i = 0; i < currentBatchSize; i++) {
                    const shuffledRoles = shuffleRoles(useRealisticMode);
                    shuffledRoles.forEach((role, position) => {
                        distributionMatrix[role][position]++;
                    });
                }

                completedIterations += currentBatchSize;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const progress = (completedIterations / iterations) * 100;
                updateProgress(progress, completedIterations, iterations);

                // –ü–∞—É–∑–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
                await new Promise(resolve => setTimeout(resolve, 1));
            }

            if (!shouldStop) {
                const endTime = Date.now();
                const executionTime = endTime - startTime;

                // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                currentResults = analyzeResults(distributionMatrix, completedIterations, executionTime, confidenceLevel, simulationMode);

                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                displayResults(currentResults);
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞: ' + error.message);
        } finally {
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            benchmarkRunning = false;
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;

            if (shouldStop) {
                elements.progressText.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
            }
        }
    }

    function getIterationsCount() {
        if (elements.iterations.value === 'custom') {
            return parseInt(elements.customValue.value) || 1000000;
        }
        return parseInt(elements.iterations.value);
    }

    function updateProgress(percentage, completed, total) {
        elements.progressFill.style.width = percentage + '%';
        elements.progressText.textContent =
            `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${completed.toLocaleString()} –∏–∑ ${total.toLocaleString()} –∏—Ç–µ—Ä–∞—Ü–∏–π (${percentage.toFixed(1)}%)`;
    }

    function stopBenchmark() {
        shouldStop = true;
        elements.stopBtn.disabled = true;
    }

    function resetResults() {
        elements.results.style.display = 'none';
        elements.progressContainer.style.display = 'none';
        currentResults = null;
    }

    // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function analyzeResults(distributionMatrix, totalIterations, executionTime, confidenceLevel, simulationMode) {
        const results = {
            totalIterations,
            executionTime,
            confidenceLevel,
            simulationMode,
            distributionMatrix,
            statistics: {},
            chiSquareTests: {},
            interpretation: []
        };

        // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
        ROLE_NAMES.forEach(role => {
            const expectedFrequency = (ROLES_CONFIG[role].count / TOTAL_PLAYERS) * totalIterations;
            const observed = distributionMatrix[role];

            // –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const mean = observed.reduce((sum, val) => sum + val, 0) / TOTAL_PLAYERS;
            const variance = observed.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (TOTAL_PLAYERS - 1);
            const stdDev = Math.sqrt(variance);

            // –¢–µ—Å—Ç —Ö–∏-–∫–≤–∞–¥—Ä–∞—Ç
            const chiSquare = observed.reduce((sum, obs) => {
                return sum + Math.pow(obs - expectedFrequency, 2) / expectedFrequency;
            }, 0);

            const degreesOfFreedom = TOTAL_PLAYERS - 1;
            const criticalValue = getCriticalValue(confidenceLevel, degreesOfFreedom);
            const pValue = calculatePValue(chiSquare, degreesOfFreedom);

            results.statistics[role] = {
                expectedFrequency,
                mean,
                variance,
                stdDev,
                min: Math.min(...observed),
                max: Math.max(...observed),
                range: Math.max(...observed) - Math.min(...observed)
            };

            results.chiSquareTests[role] = {
                chiSquare,
                degreesOfFreedom,
                criticalValue,
                pValue,
                isSignificant: chiSquare > criticalValue,
                interpretation: interpretChiSquareTest(chiSquare, criticalValue, pValue, confidenceLevel)
            };
        });

        // –û–±—â–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
        results.interpretation = generateInterpretation(results);

        return results;
    }

    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ö–∏-–∫–≤–∞–¥—Ä–∞—Ç (–ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–µ)
    function getCriticalValue(confidenceLevel, df) {
        const criticalValues = {
            0.90: [2.706, 4.605, 6.251, 7.779, 9.236, 10.645, 12.017, 13.362, 14.684, 15.987],
            0.95: [3.841, 5.991, 7.815, 9.488, 11.070, 12.592, 14.067, 15.507, 16.919, 18.307],
            0.99: [6.635, 9.210, 11.345, 13.277, 15.086, 16.812, 18.475, 20.090, 21.666, 23.209]
        };

        return criticalValues[confidenceLevel][Math.min(df - 1, 9)] ||
            criticalValues[confidenceLevel][9] + (df - 10) * 1.5;
    }

    // –ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç p-value –¥–ª—è —Ö–∏-–∫–≤–∞–¥—Ä–∞—Ç
    function calculatePValue(chiSquare, df) {
        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è p-value
        if (chiSquare < 1) return 0.9;
        if (chiSquare < 3) return 0.5;
        if (chiSquare < 6) return 0.2;
        if (chiSquare < 10) return 0.05;
        if (chiSquare < 15) return 0.01;
        return 0.001;
    }

    function interpretChiSquareTest(chiSquare, criticalValue, pValue, confidenceLevel) {
        if (chiSquare <= criticalValue) {
            return `–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ (p > ${1 - confidenceLevel})`;
        } else {
            return `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (p < ${1 - confidenceLevel})`;
        }
    }

    function generateInterpretation(results) {
        const interpretation = [];
        let hasSignificantDeviations = false;

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const modeDescription = results.simulationMode === 'realistic'
            ? '—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (–∏–º–∏—Ç–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π –±—Ä–∞—É–∑–µ—Ä–∞)'
            : '–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ (–æ–¥–∏–Ω –ø–æ—Ç–æ–∫ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª)';

        interpretation.push(`üîß –†–ï–ñ–ò–ú –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø: –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω –≤ ${modeDescription}`);

        ROLE_NAMES.forEach(role => {
            const test = results.chiSquareTests[role];
            const stats = results.statistics[role];
            const roleName = ROLES_CONFIG[role].name;

            if (test.isSignificant) {
                hasSignificantDeviations = true;
                interpretation.push(`‚ùå ${roleName}: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (œá¬≤ = ${test.chiSquare.toFixed(2)}, p < ${1 - results.confidenceLevel})`);
            } else {
                interpretation.push(`‚úÖ ${roleName}: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–ª–∏–∑–∫–æ –∫ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–º—É (œá¬≤ = ${test.chiSquare.toFixed(2)}, p > ${1 - results.confidenceLevel})`);
            }

            // –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–±—Ä–æ—Å–∞
            const coefficientOfVariation = (stats.stdDev / stats.mean) * 100;
            if (coefficientOfVariation > 10) {
                interpretation.push(`‚ö†Ô∏è ${roleName}: –í—ã—Å–æ–∫–∏–π —Ä–∞–∑–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏–π (CV = ${coefficientOfVariation.toFixed(1)}%)`);
            }
        });

        // –û–±—â–∏–π –≤—ã–≤–æ–¥ —Å —É—á–µ—Ç–æ–º —Ä–µ–∂–∏–º–∞
        if (hasSignificantDeviations) {
            if (results.simulationMode === 'realistic') {
                interpretation.unshift('üîç –û–ë–©–ò–ô –í–´–í–û–î: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö. –≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –ì–ü–°–ß –∏–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º.');
            } else {
                interpretation.unshift('üîç –û–ë–©–ò–ô –í–´–í–û–î: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ê–ª–≥–æ—Ä–∏—Ç–º –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–º–µ—â–µ–Ω–∏—è.');
            }
        } else {
            if (results.simulationMode === 'realistic') {
                interpretation.unshift('‚úÖ –û–ë–©–ò–ô –í–´–í–û–î: –ê–ª–≥–æ—Ä–∏—Ç–º Fisher-Yates —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–∞–∂–µ –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö. –í—Å–µ —Ä–æ–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º.');
            } else {
                interpretation.unshift('‚úÖ –û–ë–©–ò–ô –í–´–í–û–î: –ê–ª–≥–æ—Ä–∏—Ç–º Fisher-Yates —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –í—Å–µ —Ä–æ–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º.');
            }
        }

        return interpretation;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function displayResults(results) {
        elements.results.style.display = 'block';

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        document.getElementById('results-summary').textContent =
            `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${results.totalIterations.toLocaleString()} –∏—Ç–µ—Ä–∞—Ü–∏–π –∑–∞ ${(results.executionTime / 1000).toFixed(1)} —Å–µ–∫—É–Ω–¥`;

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        displaySummaryStats(results);

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤
        displayStatisticalTests(results);

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
        buildHeatmap(results);

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        buildCharts(results);

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        buildResultsTable(results);

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
        displayInterpretation(results);
    }

    function displaySummaryStats(results) {
        elements.summaryStats.innerHTML = '';

        const cards = [
            {
                value: results.totalIterations.toLocaleString(),
                label: '–ò—Ç–µ—Ä–∞—Ü–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'
            },
            {
                value: (results.executionTime / 1000).toFixed(1) + 's',
                label: '–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
            },
            {
                value: Math.round(results.totalIterations / (results.executionTime / 1000)).toLocaleString(),
                label: '–ò—Ç–µ—Ä–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É'
            },
            {
                value: results.confidenceLevel * 100 + '%',
                label: '–£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è'
            }
        ];

        cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'stat-card';
            cardElement.innerHTML = `
                    <div class="stat-value">${card.value}</div>
                    <div class="stat-label">${card.label}</div>
                `;
            elements.summaryStats.appendChild(cardElement);
        });
    }

    function displayStatisticalTests(results) {
        elements.testResults.innerHTML = '';

        ROLE_NAMES.forEach(role => {
            const test = results.chiSquareTests[role];
            const roleName = ROLES_CONFIG[role].name;

            const testElement = document.createElement('div');
            testElement.className = 'test-result';
            testElement.innerHTML = `
                    <h5>${roleName}</h5>
                    <p><strong>œá¬≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> ${test.chiSquare.toFixed(3)}</p>
                    <p><strong>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</strong> ${test.criticalValue.toFixed(3)}</p>
                    <p><strong>P-–∑–Ω–∞—á–µ–Ω–∏–µ:</strong> ${test.pValue < 0.001 ? '< 0.001' : test.pValue.toFixed(3)}</p>
                    <p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${test.isSignificant ? '‚ùå –ó–Ω–∞—á–∏–º–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ' : '‚úÖ –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ'}</p>
                    <p><em>${test.interpretation}</em></p>
                `;
            elements.testResults.appendChild(testElement);
        });
    }

    function buildHeatmap(results) {
        elements.heatmap.innerHTML = '';

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –ø–æ–∑–∏—Ü–∏–π
        const headerCell = document.createElement('div');
        headerCell.className = 'heatmap-cell heatmap-header';
        headerCell.textContent = '–†–æ–ª—å \\ –ü–æ–∑–∏—Ü–∏—è';
        elements.heatmap.appendChild(headerCell);

        for (let pos = 1; pos <= TOTAL_PLAYERS; pos++) {
            const posCell = document.createElement('div');
            posCell.className = 'heatmap-cell heatmap-header';
            posCell.textContent = pos.toString();
            elements.heatmap.appendChild(posCell);
        }

        // –°—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
        ROLE_NAMES.forEach(role => {
            const roleName = ROLES_CONFIG[role].name;
            const roleColor = ROLES_CONFIG[role].color;
            const distribution = results.distributionMatrix[role];
            const expectedValue = results.statistics[role].expectedFrequency;

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–æ–ª–∏
            const roleCell = document.createElement('div');
            roleCell.className = 'heatmap-cell heatmap-role';
            roleCell.textContent = roleName;
            roleCell.style.backgroundColor = roleColor;
            elements.heatmap.appendChild(roleCell);

            // –Ø—á–µ–π–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
            distribution.forEach((count, index) => {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';

                const deviation = ((count - expectedValue) / expectedValue) * 100;
                const absDeviation = Math.abs(deviation);

                // –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
                let backgroundColor;
                if (absDeviation < 2) {
                    backgroundColor = '#e8f5e9'; // –ó–µ–ª–µ–Ω—ã–π - –Ω–æ—Ä–º–∞
                } else if (absDeviation < 5) {
                    backgroundColor = '#fff3e0'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π - –Ω–µ–±–æ–ª—å—à–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
                } else {
                    backgroundColor = '#ffebee'; // –ö—Ä–∞—Å–Ω—ã–π - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
                }

                cell.style.backgroundColor = backgroundColor;
                cell.innerHTML = `
                        <div style="font-weight: bold;">${count}</div>
                        <div style="font-size: 0.8em; color: ${deviation > 0 ? '#d32f2f' : '#1976d2'};">
                            ${deviation > 0 ? '+' : ''}${deviation.toFixed(1)}%
                        </div>
                    `;

                elements.heatmap.appendChild(cell);
            });
        });
    }

    function buildCharts(results) {
        buildRolesChart(results);
        buildDeviationsChart(results);
    }

    function buildRolesChart(results) {
        const ctx = document.getElementById('roles-chart').getContext('2d');

        const datasets = ROLE_NAMES.map(role => {
            const roleName = ROLES_CONFIG[role].name;
            const roleColor = ROLES_CONFIG[role].color;
            const distribution = results.distributionMatrix[role];

            return {
                label: roleName,
                data: distribution,
                backgroundColor: roleColor + '80',
                borderColor: roleColor,
                borderWidth: 2
            };
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: TOTAL_PLAYERS}, (_, i) => `–ü–æ–∑–∏—Ü–∏—è ${i + 1}`),
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–∞–¥–µ–Ω–∏–π'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function (context) {
                                const role = ROLE_NAMES[context.datasetIndex];
                                const expected = results.statistics[role].expectedFrequency;
                                const actual = context.parsed.y;
                                const deviation = ((actual - expected) / expected * 100).toFixed(1);
                                return `–û–∂–∏–¥–∞–ª–æ—Å—å: ${expected.toFixed(0)}, –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ${deviation}%`;
                            }
                        }
                    }
                }
            }
        });
    }

    function buildDeviationsChart(results) {
        const ctx = document.getElementById('deviations-chart').getContext('2d');

        const datasets = ROLE_NAMES.map(role => {
            const roleName = ROLES_CONFIG[role].name;
            const roleColor = ROLES_CONFIG[role].color;
            const distribution = results.distributionMatrix[role];
            const expected = results.statistics[role].expectedFrequency;

            const deviations = distribution.map(actual =>
                ((actual - expected) / expected * 100)
            );

            return {
                label: roleName,
                data: deviations,
                backgroundColor: roleColor + '80',
                borderColor: roleColor,
                borderWidth: 2
            };
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: TOTAL_PLAYERS}, (_, i) => `–ü–æ–∑–∏—Ü–∏—è ${i + 1}`),
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: '–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ (%)'
                        },
                        grid: {
                            color: function (context) {
                                if (context.tick.value === 0) {
                                    return '#000000';
                                }
                                return '#e0e0e0';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }

    function buildResultsTable(results) {
        let tableHTML = `
                <thead>
                    <tr>
                        <th>–†–æ–ª—å</th>
                        <th>–û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
                        <th>–°—Ä–µ–¥–Ω–µ–µ</th>
                        <th>–°—Ç–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th>
                        <th>–ú–∏–Ω</th>
                        <th>–ú–∞–∫—Å</th>
                        <th>–†–∞–∑–º–∞—Ö</th>
                        <th>œá¬≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                        <th>P-–∑–Ω–∞—á–µ–Ω–∏–µ</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    </tr>
                </thead>
                <tbody>
            `;

        ROLE_NAMES.forEach(role => {
            const roleName = ROLES_CONFIG[role].name;
            const stats = results.statistics[role];
            const test = results.chiSquareTests[role];

            tableHTML += `
                    <tr>
                        <td style="background-color: ${ROLES_CONFIG[role].color}20; font-weight: bold;">${roleName}</td>
                        <td>${stats.expectedFrequency.toFixed(0)}</td>
                        <td>${stats.mean.toFixed(1)}</td>
                        <td>${stats.stdDev.toFixed(1)}</td>
                        <td>${stats.min}</td>
                        <td>${stats.max}</td>
                        <td>${stats.range}</td>
                        <td>${test.chiSquare.toFixed(3)}</td>
                        <td>${test.pValue < 0.001 ? '< 0.001' : test.pValue.toFixed(3)}</td>
                        <td>${test.isSignificant ? '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ' : '‚úÖ –ù–æ—Ä–º–∞'}</td>
                    </tr>
                `;
        });

        tableHTML += '</tbody>';
        elements.resultsTable.innerHTML = tableHTML;
    }

    function displayInterpretation(results) {
        const interpretationHTML = `
                <ul>
                    ${results.interpretation.map(item => `<li>${item}</li>`).join('')}
                </ul>
                
                <h5 style="margin-top: 20px;">üìö –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:</h5>
                <ul>
                    <li><strong>–¢–µ—Å—Ç —Ö–∏-–∫–≤–∞–¥—Ä–∞—Ç:</strong> –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–∏–ø–æ—Ç–µ–∑—É –æ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ä–æ–ª–µ–π –ø–æ –ø–æ–∑–∏—Ü–∏—è–º</li>
                    <li><strong>–£—Ä–æ–≤–µ–Ω—å –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏:</strong> ${(1 - results.confidenceLevel) * 100}% (Œ± = ${1 - results.confidenceLevel})</li>
                    <li><strong>–°—Ç–µ–ø–µ–Ω–∏ —Å–≤–æ–±–æ–¥—ã:</strong> ${TOTAL_PLAYERS - 1} –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏</li>
                    <li><strong>–û–∂–∏–¥–∞–µ–º–∞—è —á–∞—Å—Ç–æ—Ç–∞:</strong> –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–æ–ª–µ–π / –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π) √ó –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π</li>
                </ul>
                
                <h5 style="margin-top: 20px;">üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h5>
                <ul>
                    <li>–ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–Ω–∞—á–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∞–ª–≥–æ—Ä–∏—Ç–º–∞ Fisher-Yates</li>
                    <li>–ù–µ–±–æ–ª—å—à–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (< 5%) –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ª—É—á–∞–π–Ω—ã–º–∏ –∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞</li>
                    <li>–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–æ 5-10 –º–∏–ª–ª–∏–æ–Ω–æ–≤</li>
                    <li>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</li>
                </ul>
            `;

        elements.interpretation.innerHTML = interpretationHTML;
    }

    // –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
    function exportToCsv() {
        if (!currentResults) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–µ–Ω—á–º–∞—Ä–∫.');
            return;
        }

        let csvContent = '–†–æ–ª—å,–ü–æ–∑–∏—Ü–∏—è,–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ,–û–∂–∏–¥–∞–µ–º–æ–µ,–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ_%\n';

        ROLE_NAMES.forEach(role => {
            const roleName = ROLES_CONFIG[role].name;
            const distribution = currentResults.distributionMatrix[role];
            const expected = currentResults.statistics[role].expectedFrequency;

            distribution.forEach((count, position) => {
                const deviation = ((count - expected) / expected * 100).toFixed(2);
                csvContent += `"${roleName}",${position + 1},${count},${expected.toFixed(0)},${deviation}\n`;
            });
        });

        downloadFile(csvContent, 'role-distribution-benchmark.csv', 'text/csv');
    }

    function exportToJson() {
        if (!currentResults) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–µ–Ω—á–º–∞—Ä–∫.');
            return;
        }

        const exportData = {
            metadata: {
                timestamp: new Date().toISOString(),
                totalIterations: currentResults.totalIterations,
                executionTime: currentResults.executionTime,
                confidenceLevel: currentResults.confidenceLevel
            },
            distributionMatrix: currentResults.distributionMatrix,
            statistics: currentResults.statistics,
            chiSquareTests: currentResults.chiSquareTests,
            interpretation: currentResults.interpretation
        };

        const jsonContent = JSON.stringify(exportData, null, 2);
        downloadFile(jsonContent, 'role-distribution-benchmark.json', 'application/json');
    }

    function exportToHtml() {
        if (!currentResults) {
            alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–µ–Ω—á–º–∞—Ä–∫.');
            return;
        }

        const reportHTML = generateHtmlReport(currentResults);
        downloadFile(reportHTML, 'role-distribution-report.html', 'text/html');
    }

    function generateHtmlReport(results) {
        return `
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û—Ç—á–µ—Ç: –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π –≤ –ú–∞—Ñ–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 40px; }
        .summary { background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 30px; }
        .results-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .results-table th, .results-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .results-table th { background: #f2f2f2; }
        .interpretation { background: #e8f5e8; padding: 20px; border-radius: 5px; margin-top: 30px; }
        .significant { color: #d32f2f; font-weight: bold; }
        .normal { color: #388e3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé≠ –û—Ç—á–µ—Ç: –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π –≤ –ú–∞—Ñ–∏–∏</h1>
        <p>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleString('ru-RU')}</p>
    </div>
    
    <div class="summary">
        <h2>üìä –°–≤–æ–¥–∫–∞</h2>
        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π:</strong> ${results.totalIterations.toLocaleString()}</p>
        <p><strong>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> ${(results.executionTime / 1000).toFixed(1)} —Å–µ–∫—É–Ω–¥</p>
        <p><strong>–£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è:</strong> ${results.confidenceLevel * 100}%</p>
        <p><strong>–ò—Ç–µ—Ä–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É:</strong> ${Math.round(results.totalIterations / (results.executionTime / 1000))
            .toLocaleString()}</p>
    </div>
    
    <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤</h2>
    <table class="results-table">
        <thead>
            <tr>
                <th>–†–æ–ª—å</th>
                <th>œá¬≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                <th>P-–∑–Ω–∞—á–µ–Ω–∏–µ</th>
                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                <th>–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è</th>
            </tr>
        </thead>
        <tbody>
            ${ROLE_NAMES.map(role => {
            const roleName = ROLES_CONFIG[role].name;
            const test = results.chiSquareTests[role];
            return `
                    <tr>
                        <td><strong>${roleName}</strong></td>
                        <td>${test.chiSquare.toFixed(3)}</td>
                        <td>${test.pValue < 0.001 ? '< 0.001' : test.pValue.toFixed(3)}</td>
                        <td class="${test.isSignificant ? 'significant' : 'normal'}">
                            ${test.isSignificant ? '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ' : '‚úÖ –ù–æ—Ä–º–∞'}
                        </td>
                        <td>${test.interpretation}</td>
                    </tr>
                `;
        }).join('')}
        </tbody>
    </table>
    
    <div class="interpretation">
        <h2>üîç –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
        <ul>
            ${results.interpretation.map(item => `<li>${item}</li>`).join('')}
        </ul>
    </div>
</body>
</html>
            `;
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], {type: mimeType});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>
