<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Раздача ролей</title>
    <link rel="stylesheet" href="/css/style-role-selector.css">
</head>
<body>
<div class="container">
    <div class="game-info">
        <div class="game-title" id="game-title" th:text="${gameTitle}">Загрузка...</div>
    </div>

    <div class="timer" id="timer">00:00</div>

    <div class="progress-bar">
        <div class="progress" id="progress"></div>
    </div>

    <div class="player-card-container">
        <!-- Фото и ник игрока - всегда видимые, не переворачиваются -->
        <div class="player-info-static">
            <div class="player-photo" id="player-photo"></div>
            <div class="player-nickname" id="player-nickname">Загрузка...</div>
        </div>

        <div class="player-card" id="player-card">
            <div class="card-inner" id="card">
                <div class="card-front">
                    <div class="player-number" id="player-number">1</div>
                    <div class="card-icon front-icon">❓</div>
                    <div class="role-name">Нажмите, чтобы увидеть роль</div>
                </div>
                <div class="card-back" id="card-back">
                    <div class="player-number" id="player-number-back">1</div>
                    <div class="card-icon" id="role-icon"></div>
                    <div class="role-name" id="role-name">Мирный житель</div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn navigation" id="prev-btn" disabled>← Предыдущий</button>
        <button class="btn navigation" id="next-btn" disabled>Следующий →</button>
    </div>

    <div class="controls" style="margin-top: 10px;">
        <button class="btn reset" id="reset-btn">Перемешать роли</button>
        <button class="btn primary" id="next-game-btn">Следующая игра</button>
    </div>

    <div class="controls" style="margin-top: 10px;" id="polemica-controls" th:if="${service == 'polemica'}">
        <button class="btn export" id="export-btn">Экспорт в Polemica</button>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM загружен, инициализация роль-селектора...');
        
        // Получаем параметры из шаблона
        let id = [[${id}]];
        let tournamentId = [[${tournamentId}]];
        let gameNum = [[${gameNum}]];
        let tableNum = [[${tableNum}]];
        let phase = [[${phase}]];
        let service = [[${service}]];

        console.log('Параметры игры:', {
            id,
            tournamentId,
            gameNum,
            tableNum,
            phase,
            service
        });

        // Получаем данные игроков из модели
        let serverPlayers = /*[[${players}]]*/ [];
        console.log('Данные игроков с сервера:', serverPlayers);

        // Элементы DOM
        const playerCardEl = document.getElementById('player-card');
        const card = document.getElementById('card');
        const cardBack = document.getElementById('card-back');
        const roleIcon = document.getElementById('role-icon');
        const roleName = document.getElementById('role-name');
        const playerNumber = document.getElementById('player-number');
        const playerNumberBack = document.getElementById('player-number-back');
        const playerNickname = document.getElementById('player-nickname');
        const playerPhoto = document.getElementById('player-photo');
        const progressBar = document.getElementById('progress');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const resetBtn = document.getElementById('reset-btn');
        const nextGameBtn = document.getElementById('next-game-btn');
        const exportBtn = document.getElementById('export-btn');
        const timerEl = document.getElementById('timer');

        console.log('Элементы DOM найдены:', {
            resetBtn: !!resetBtn,
            nextGameBtn: !!nextGameBtn,
            exportBtn: !!exportBtn
        });

        // Состояние игры
        let players = [];
        let currentPlayerIndex = 0;
        let isCardFlipped = false;

        // Переменные для секундомера
        let timerInterval;
        let timerStart;
        let timerRunning = false;

        // Переменные для отслеживания свайпов
        let touchStartX = 0;
        let touchEndX = 0;

        // Конфигурация ролей
        const roleConfig = {
            red: {name: 'Мирный житель'},
            sher: {name: 'Шериф'},
            black: {name: 'Мафия'},
            don: {name: 'Дон мафии'}
        };

        function getRoles() {
            const playerCount = serverPlayers.length;
            console.log('Создание ролей для', playerCount, 'игроков');

            let roles = [];

            if (playerCount === 10) {
                // Стандартная игра на 10 игроков
                roles = [
                    'red', 'red', 'red', 'red', 'red', 'red',
                    'sher',
                    'black', 'black',
                    'don'
                ];
            } else {
                // Адаптируем под количество игроков
                const mafiaCount = Math.floor(playerCount / 3);
                const sheriffCount = 1;
                const redCount = playerCount - mafiaCount - sheriffCount;

                roles = [];
                // Добавляем мирных
                for (let i = 0; i < redCount; i++) {
                    roles.push('red');
                }
                // Добавляем шерифа
                roles.push('sher');
                // Добавляем мафию (дон + обычная мафия)
                roles.push('don');
                for (let i = 1; i < mafiaCount; i++) {
                    roles.push('black');
                }
            }

            // Перемешивание ролей
            for (let attempts = 0; attempts < 100; attempts++) {
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }
            }

            console.log('Созданные роли:', roles);
            return roles;
        }

        // Инициализация игры
        function initGame() {
            let roles = getRoles();
            players = serverPlayers.map((player, index) => ({
                id: player.place || (index + 1),
                nickname: player.nickname || `Игрок ${player.place || (index + 1)}`,
                photoUrl: player.photoUrl || '/images/placeholder.png',
                role: roles[index],
                seen: false,
                cardFlipped: false
            }));

            currentPlayerIndex = 0;
            isCardFlipped = false;
            resetTimer();
            startTimer();
            updateUI();
        }

        // Обновление интерфейса
        function updateUI() {
            if (players.length === 0) return;

            const player = players[currentPlayerIndex];

            // Обновление номера игрока
            playerNumber.textContent = player.id;
            playerNumberBack.textContent = player.id;

            // Обновление ника игрока
            playerNickname.textContent = player.nickname;

            // Обновление фотографии игрока
            if (player.photoUrl && player.photoUrl !== '/images/placeholder.png') {
                playerPhoto.style.backgroundImage = `url("${player.photoUrl}")`;
                playerPhoto.style.backgroundSize = 'cover';
                playerPhoto.style.backgroundPosition = 'center';
                playerPhoto.classList.add('has-photo');
            } else {
                playerPhoto.style.backgroundImage = 'none';
                playerPhoto.classList.remove('has-photo');
            }

            // Обновление роли на обратной стороне карты
            cardBack.className = 'card-back';
            cardBack.classList.add(player.role);

            // Обновление иконки
            roleIcon.className = 'card-icon';
            roleIcon.classList.add(player.role);

            // Обновление имени роли
            roleName.textContent = roleConfig[player.role].name;

            // Обновляем состояние карты (перевернута или нет)
            // Если текущая карта была открыта, то и следующая должна быть открыта
            if (isCardFlipped) {
                card.classList.add('flipped');
                player.cardFlipped = true;
                player.seen = true;
            } else {
                card.classList.remove('flipped');
                player.cardFlipped = false;
            }

            // Обновление прогресс-бара
            const progress = ((currentPlayerIndex + 1) / players.length) * 100;
            progressBar.style.width = `${progress}%`;

            // Обновление кнопок
            nextBtn.disabled = currentPlayerIndex >= players.length - 1;
            prevBtn.disabled = currentPlayerIndex <= 0;
        }

        // Функции для секундомера
        function startTimer() {
            if (!timerRunning) {
                timerStart = new Date().getTime();
                timerRunning = true;
                timerInterval = setInterval(updateTimer, 100);
            }
        }

        function updateTimer() {
            const now = new Date().getTime();
            const elapsed = now - timerStart;

            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            timerEl.textContent =
                (minutes < 10 ? '0' : '') + minutes + ':' +
                (seconds < 10 ? '0' : '') + seconds;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerRunning = false;
            timerEl.textContent = '00:00';
        }

        // Обработка переворота карты
        function toggleCard() {
            isCardFlipped = !isCardFlipped;
            players[currentPlayerIndex].cardFlipped = isCardFlipped;
            if (isCardFlipped) {
                card.classList.add('flipped');
                players[currentPlayerIndex].seen = true;
                nextBtn.disabled = currentPlayerIndex >= players.length - 1;
                prevBtn.disabled = currentPlayerIndex <= 0;
            } else {
                card.classList.remove('flipped');
            }
        }

        // Переход к следующему игроку
        function nextPlayer() {
            if (currentPlayerIndex < players.length - 1) {
                playerCardEl.classList.add('slide-out-left');

                playerCardEl.addEventListener('animationend', function handleSlideOut() {
                    playerCardEl.removeEventListener('animationend', handleSlideOut);

                    currentPlayerIndex++;
                    resetTimer();
                    startTimer();
                    updateUI();

                    playerCardEl.classList.remove('slide-out-left');
                    playerCardEl.classList.add('slide-in-right');

                    playerCardEl.addEventListener('animationend', function handleSlideIn() {
                        playerCardEl.removeEventListener('animationend', handleSlideIn);
                        playerCardEl.classList.remove('slide-in-right');
                    }, {once: true});
                }, {once: true});
            } else {
                alert('Все игроки увидели свои роли! Игра может начинаться.');
            }
        }

        // Переход к предыдущему игроку
        function prevPlayer() {
            if (currentPlayerIndex > 0) {
                playerCardEl.classList.add('slide-out-right');

                playerCardEl.addEventListener('animationend', function handleSlideOut() {
                    playerCardEl.removeEventListener('animationend', handleSlideOut);

                    currentPlayerIndex--;
                    resetTimer();
                    startTimer();
                    updateUI();

                    playerCardEl.classList.remove('slide-out-right');
                    playerCardEl.classList.add('slide-in-left');

                    playerCardEl.addEventListener('animationend', function handleSlideIn() {
                        playerCardEl.removeEventListener('animationend', handleSlideIn);
                        playerCardEl.classList.remove('slide-in-left');
                    }, {once: true});
                }, {once: true});
            }
        }

        // Обработка свайпа
        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;
            const minSwipeDistance = 50;

            if (swipeDistance > minSwipeDistance) {
                if (!prevBtn.disabled) {
                    prevPlayer();
                }
            } else if (swipeDistance < -minSwipeDistance) {
                if (!nextBtn.disabled) {
                    nextPlayer();
                }
            }
        }

        // Функция для перехода к следующей игре
        function goToNextGame() {
            console.log('Функция goToNextGame() вызвана');
            console.log('Кнопка "Следующая игра" нажата');

            try {
                // Проверяем, поддерживается ли confirm
                if (typeof confirm === 'function') {
                    if (confirm('Перейти к следующей игре?')) {
                        console.log('Пользователь подтвердил переход к следующей игре');
                        executeNextGame();
                    } else {
                        console.log('Пользователь отменил переход к следующей игре');
                    }
                } else {
                    console.error('confirm() не поддерживается, выполняем без подтверждения');
                    executeNextGame();
                }
            } catch (error) {
                console.error('Ошибка при вызове confirm():', error);
                executeNextGame();
            }
        }

        // Отдельная функция для выполнения перехода к следующей игре
        function executeNextGame() {
            console.log('Выполнение перехода к следующей игре:', service, tournamentId, phase, tableNum, gameNum);

            const nextGameUrl = `/${service}/tournaments/${tournamentId}/phases/${phase}/tables/${tableNum}/games/${gameNum}/nextgame`;
            console.log('URL для запроса:', nextGameUrl);

            fetch(nextGameUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            }).then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }).then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    try {
                        if (typeof alert === 'function') {
                            alert(data.message);
                        } else {
                            console.log('Alert не поддерживается, сообщение:', data.message);
                        }
                    } catch (alertError) {
                        console.error('Ошибка при вызове alert():', alertError);
                        console.log('Сообщение:', data.message);
                    }

                    if (data.redirectUrl) {
                        console.log('Перенаправление на:', data.redirectUrl);
                        window.location.href = data.redirectUrl;
                    }
                } else {
                    const errorMessage = data.message || 'Ошибка при переходе к следующей игре';
                    console.error('Ошибка от сервера:', errorMessage);
                    try {
                        if (typeof alert === 'function') {
                            alert(errorMessage);
                        } else {
                            console.log('Alert не поддерживается, ошибка:', errorMessage);
                        }
                    } catch (alertError) {
                        console.error('Ошибка при вызове alert():', alertError);
                    }
                }
            }).catch(error => {
                console.error('Network error:', error);
                const errorMessage = 'Ошибка сети при переходе к следующей игре: ' + error.message;
                try {
                    if (typeof alert === 'function') {
                        alert(errorMessage);
                    } else {
                        console.log('Alert не поддерживается, ошибка сети:', errorMessage);
                    }
                } catch (alertError) {
                    console.error('Ошибка при вызове alert():', alertError);
                }
            });
        }

        // Функция для экспорта ролей в Polemica
        function exportToPolemica() {
            if (confirm('Экспортировать роли в Polemica?')) {
                const roles = {};
                players.forEach(player => {
                    roles[player.id] = player.role;
                });

                fetch(`/${id}/exportToPolemica`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roles)
                }).then(response => {
                    if (response.ok) {
                        alert('Роли успешно экспортированы в Polemica!');
                    } else {
                        alert('Ошибка при экспорте ролей');
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('Ошибка при экспорте ролей');
                });
            }
        }

        // Функция для перемешивания ролей
        function shuffleRoles() {
            console.log('Кнопка "Перемешать роли" нажата');
            console.log('Перемешивание ролей, количество игроков:', players.length);

            // Создаем роли в зависимости от количества игроков
            let roles = [];
            const playerCount = players.length;

            if (playerCount === 10) {
                // Стандартная игра на 10 игроков
                roles = [
                    'red', 'red', 'red', 'red', 'red', 'red',
                    'sher',
                    'black', 'black',
                    'don'
                ];
            } else {
                // Адаптируем под количество игроков
                const mafiaCount = Math.floor(playerCount / 3);
                const sheriffCount = 1;
                const redCount = playerCount - mafiaCount - sheriffCount;

                roles = [];
                // Добавляем мирных
                for (let i = 0; i < redCount; i++) {
                    roles.push('red');
                }
                // Добавляем шерифа
                roles.push('sher');
                // Добавляем мафию (дон + обычная мафия)
                roles.push('don');
                for (let i = 1; i < mafiaCount; i++) {
                    roles.push('black');
                }
            }

            // Перемешивание ролей
            for (let attempts = 0; attempts < 100; attempts++) {
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }
            }

            console.log('Новые роли:', roles);

            // Обновляем роли игроков
            players.forEach((player, index) => {
                if (index < roles.length) {
                    player.role = roles[index];
                    player.seen = false;
                    player.cardFlipped = false;
                }
            });

            currentPlayerIndex = 0;
            isCardFlipped = false;
            resetTimer();
            startTimer();
            updateUI();

            console.log('Роли перемешаны успешно');
        }

        // Обработчики событий
        playerCardEl.addEventListener('click', function (e) {
            if (e.target.closest('.btn') === null) {
                toggleCard();
            }
        });

        playerCardEl.addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        playerCardEl.addEventListener('touchend', function (e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        nextBtn.addEventListener('click', nextPlayer);
        prevBtn.addEventListener('click', prevPlayer);

        console.log('Добавляем обработчик для кнопки "Следующая игра"');
        if (nextGameBtn) {
            nextGameBtn.addEventListener('click', function (e) {
                console.log('Обработчик кнопки "Следующая игра" вызван', e);
                e.preventDefault();
                e.stopPropagation();
                goToNextGame();
            });
        } else {
            console.error('Кнопка "Следующая игра" не найдена!');
        }

        if (exportBtn) {
            console.log('Добавляем обработчик для кнопки "Экспорт в Polemica"');
            exportBtn.addEventListener('click', exportToPolemica);
        }

        console.log('Добавляем обработчик для кнопки "Перемешать роли"');
        if (resetBtn) {
            resetBtn.addEventListener('click', function (e) {
                console.log('Обработчик кнопки "Перемешать роли" вызван', e);
                e.preventDefault();
                e.stopPropagation();

                // Проверяем, поддерживается ли confirm
                try {
                    if (typeof confirm === 'function') {
                        if (confirm('Вы уверены, что хотите перемешать роли и начать заново?')) {
                            console.log('Пользователь подтвердил перемешивание ролей');
                            shuffleRoles();
                        } else {
                            console.log('Пользователь отменил перемешивание ролей');
                        }
                    } else {
                        console.error('confirm() не поддерживается');
                        // Выполняем без подтверждения
                        shuffleRoles();
                    }
                } catch (error) {
                    console.error('Ошибка при вызове confirm():', error);
                    // Выполняем без подтверждения
                    shuffleRoles();
                }
            });
        } else {
            console.error('Кнопка "Перемешать роли" не найдена!');
        }

        // Инициализация
        console.log('Запуск инициализации игры...');
        initGame();
        console.log('Инициализация завершена');
    });
</script>
</body>
</html>
